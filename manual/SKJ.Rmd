---
title: "SKJ SAC13 (2000-2021)"
author: "Haikun Xu"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(results = FALSE)
```

This example code demonstrates how to compile the purse-seine catch and length composition data for the stock assessment of skipjack tuna in the eastern Pacific Ocean. Data are extracted for skipjack between 2000 and 2021 based on the R package *BSE* (version `packageVersion("BSE")`). The package can be installed using `devtools::install_github('HaikunXu/BSE',ref='main')`. Fishery definition for this data extraction is based on the interim assessment conducted in 2022.

-   Step 1: set up some directories and parameters for the extraction

```{r global setup}
# devtools::install_github('HaikunXu/BSE',ref='main') 
library(BSE)

raw_data_dir <- "D:/OneDrive - IATTC/IATTC/2022/BSE stuff from Cleridy/spp comp programs_from 2000/Raw data extractions/"
# the directory where raw extracted data from the IATTC database are stored; please ask Haikun to get those data
save_dir <- "D:/OneDrive - IATTC/IATTC/2022/BSE stuff from Cleridy/SKJ/"
# the directory where output will be saved
yr.start <- 2000
yr.end <- 2021
Species <- "SKJ"
grow.increments <- grow.increments.2cmSKJ.betyftskj # the growth increment for SKJ (2cm per month)
```

-   Step 2: lightly process the raw data so that they can be easily used in rest of steps

```{r process raw data}
# Get the total unloads for the PS fleet
total.unlds <- read.unloads.f(raw_data_dir,"Unloading2000-2021.txt",yr.start,yr.end)
# Get the CAE+IDM data
cae <- read.cae.f(raw_data_dir,"CAE-LatLon2000-2021.txt",yr.start,yr.end)
# Get the length-frequency data (length in millimeters)
lfmm <- read.lfmmdata.f(raw_data_dir,"LengthMM2000-2021.txt")
# Get the grouped length-frequency output
lfgrpd <- read.lengthfreq.f(raw_data_dir,"LengthFreq2000-2021.txt")
```

-   Step 3: Compile the OBJ catch and composition data for SKJ

```{r OBJ}
PS <- "OBJ"
area.substitution.mat <- area.substitution.mat.SKJ.FLT.SAC2022 # for OBJ

cae.stratflg <- create.strat.flg.f(cae$latc5,cae$lonc5,is.lwrght=F,cae$month,cae$setype,cae$class,PS=PS,Species=Species)

lfgrpd.stratflg <- create.strat.flg.f(lfgrpd$lat.5deg,lfgrpd$lon.5deg,is.lwrght=T,floor(lfgrpd$moda/100),lfgrpd$setype,lfgrpd$class,PS=PS,Species=Species)

```

Check the strata definition for OBJ in both cae and lf data sets to make sure that they are correct

```{r check strata definition}
check.strat.flg.f(cae$latc5,cae$lonc5,cae.stratflg)
check.strat.flg.f(lfgrpd$lat.5deg,lfgrpd$lon.5deg,lfgrpd.stratflg)
```
